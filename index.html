<html>

  <head>
    <style>
      body{ margin: 0px; }
    </style>
  </head>

  <body>

    <script src="lib/three.min.js">             </script>
    <script src="lib/underscore.js">             </script>
    <script src="lib/jquery.min.js">            </script>
    <script src="lib/TrackballControls.js">     </script>
    <script src="lib/OrbitControls.js">     </script>
    <script src="lib/SubdivisionModifier.js">   </script>
    
    <script src="lib/VREffect.js"></script>
    <script src="lib/VRControls.js"></script>
    
    <script src="lib/ShaderLoader.js"></script>


     <script src="//js.leapmotion.com/leap-0.6.3.min.js"></script>


    <script src = "lib/UserAudio.js"            ></script>
    <script src = "lib/Stream.js"               ></script>
    <script src = "lib/AudioController.js"      ></script>
    <script src = "lib/AudioTexture.js"         ></script>
    <script src = "lib/PositionalAudio.js"      ></script>
    <script src = "lib/Looper.js"  ></script>


    <script src="RayMaker.js"></script>
    <script src="Opening.js"></script>
    <script src="create.js"></script>

    <script src="initColumns.js"></script>
    <script src="initGround.js"></script>
    <script src="initRays.js"></script>

    <script>



        var tv1 = new THREE.Vector3();
  var tv2 = new THREE.Vector3();
      var matcap = THREE.ImageUtils.loadTexture('img/rough-aluminium.jpg');

      var G = {

        dT:{type:"f" , value:0},
        time:{type:"f" , value:0},
        t_matcap:{ type:"t" , value: matcap },
        fogColor:{ type:"v3" , value: new THREE.Vector3() },
        t_audio:{type:"t",value:null},
        fingers:{ type:"v3", value:[] }

      }

      var camera, renderer, scene , controls;
      
      var vs, fs;

      var geometry, material , light;

      var raycaster = new THREE.Raycaster(); 


      var controller = new Leap.Controller();
      controller.setOptimizeHMD(true);

      var shaders = new ShaderLoader( 'shaders' , 'shaderChunks'   );

      
      var audioController = new AudioController();
        var audio = new PositionalAudio( audioController , 'audio/beyondLoop.wav' ,{
        looping: true 
      });


      G.t_audio.value = audioController.texture;

       var looper = new Looper( audioController , G.time , {

         beatsPerMinute: 141.45,
         beatsPerMeasure: 8,
         measuresPerLoop: 8

      });

      shaders.shaderSetLoaded = function(){
        init();
        animate();
      }

      shaders.load( 'vs-ground' , 'ground' , 'vertex' );
      shaders.load( 'fs-ground' , 'ground' , 'fragment' );

      shaders.load( 'vs-ray' , 'ray' , 'vertex' );
      shaders.load( 'fs-ray' , 'ray' , 'fragment' );


      var rayStoppers = [];

      var v = new THREE.Vector3();
    


      function init(){

        var w = window.innerWidth;
        var h = window.innerHeight;

        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, .01, 1000 );
        camera.position.z = 2;
        camera.position.y = .1;

        /*controls = new THREE.OrbitControls( camera );
        controls.minPolarAngle = -Math.PI * .5;
        controls.maxPolarAngle = Math.PI * .5;
        controls.autoRotate = true;*/

        renderer = new THREE.WebGLRenderer( { antialias: true } );

       // renderer.setSize( window.innerWidth, window.innerHeight );

        document.body.appendChild( renderer.domElement );
        window.addEventListener( 'resize', onWindowResize , false );
		document.body.addEventListener( 'dblclick', onDoubleClick , false );

        document.body.addEventListener("keydown", onKeyDown, true);



        /*

        VR
        
        */
        controls = new THREE.VRControls( camera );

		effect = new THREE.VREffect( renderer );
        effect.setSize( window.innerWidth, window.innerHeight );


        scene = new THREE.Scene();

        //scene.fog = new THREE.Fog( 0x000000 , 1000, 40000 );



          	/*
		Create 3d objects
		*/
		var geometry = new THREE.IcosahedronGeometry(.2 , 1 );

        var material = new THREE.MeshBasicMaterial({
          map:audioController.texture 
        });

        cube = new THREE.Mesh( geometry, new THREE.MeshNormalMaterial() );
        scene.add( cube );

        audio.playing = true;
        audio.position = cube.position;


        
        var g = new THREE.IcosahedronGeometry(.1 , 1 );
        var m = new THREE.MeshBasicMaterial({
          map:audioController.texture,
          color: 0xffffff
        });
        for(var i = 0; i < 50; i++ ){

          var mesh = new THREE.Mesh( g , m  );
          G.fingers.value.push( mesh.position );


          scene.add( mesh );


        }
 
        /*for(var i = 0; i < 50; i++ ){

          var mesh = new THREE.Mesh( g , m  );
          REPELERS.push( mesh );

          scene.add( mesh );


        }*/





        mover = new THREE.Object3D();
        mover.position.y = -5

        mover.updateMatrix();
        mover.updateMatrixWorld();
        mover.scale.multiplyScalar( 1 );
        
        scene.add( mover );

        rayMaker = new RayMaker( v , v , 0 , 1000);

        //light = new THREE.Vector3( .1 , 2 , .25 );






        initGround();
        initColumns( 100);

        var lightMarker = new THREE.Mesh( 
          new THREE.IcosahedronGeometry( .5 , 1 ),
          new THREE.MeshNormalMaterial() 
          );

        light = lightMarker.position;

        light.set( 3 , 18.2 , 0 );

        var l = new THREE.PointLight( 0xfffffff , 1 , 100 );
        l.position.copy( light );
       
        mover.add( l );
        mover.add( lightMarker );


        initRays();

        controller.connect();
        

        looper.start();
 

      }

      function animate(){

        requestAnimationFrame( animate );
        controls.update();

        G.dT.value = clock.getDelta();
        G.time.value += G.dT.value;

        cube.position.x = Math.sin( G.time.value * .1 ) * 5; 
        cube.position.y = (Math.sin( G.time.value * .1 )+1) * 5; 
        cube.position.z = Math.sin( G.time.value * .1 ) * 5;

        updateFingers( controller.frame() );

        cube.position.copy( G.fingers.value[4] );
        
        audioController.update();
        
        effect.render( scene, camera );
       // renderer.render( scene , camera );
      }

       // Resets the renderer to be the proper size
      function onWindowResize(){

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        effect.setSize( window.innerWidth , window.innerHeight );
      //  renderer.setSize( window.innerWidth, window.innerHeight );

      }

		/*
		Listen for keyboard event and zero positional sensor on appropriate keypress.
		*/
	  function onKeyDown(event) {
	    event.preventDefault();

	    if (event.keyCode == 90) { // z
	    	controls.zeroSensor();
	    }
	  };

      function onDoubleClick() {
        effect.setFullScreen( true );
      }

       function updateFingers( frame ){

     if( frame.hands[0] ){

       //console.
       for( var i = 0; i < 25; i++ ){

          var r = G.fingers.value[i];
          var bI =  i % 5 ;                     // Bone index
          var fI = Math.floor( i / 5 );     // finger index

          var p = leapToScene( frame , frame.hands[0].fingers[fI].positions[bI] );

          // z is y || x is x ||  y is -z
          tv1.set( -p[0] , -p[2] , -p[1] );
          r.copy( camera.position );
          tv1.applyQuaternion( camera.quaternion );


          r.add( tv1 );

        }



    }else{
         //console.
       for( var i = 0; i < 25; i++ ){

         var r = G.fingers.value[i+25];
         r.x = 100000;

        }



      }



    if( frame.hands[1]){

        //console.
       for( var i = 0; i < 25; i++ ){

          var r = G.fingers.value[i+25];
          var bI =  i % 5 ;                     // Bone index
          var fI = Math.floor( i / 5 );     // finger index

          var p = leapToScene( frame , frame.hands[1].fingers[fI].positions[bI] );

          // z is y || x is x ||  y is -z
          tv1.set( -p[0] , -p[2] , -p[1] );
          r.copy( camera.position );
          tv1.applyQuaternion( camera.quaternion );


          r.add( tv1 );

        }

    }else{
         //console.
       for( var i = 0; i < 25; i++ ){

         var r = G.fingers.value[i+25];
         r.x = 100000;

        }



      }

   
  }

   function leapToScene( frame , position  ){


   // console.log( position );
    var p =  position; //frame.interactionBox.normalizePoint( position );

    //p[0] *= .01;
    //p[1] *= .01;
    //p[2] *= .01;

    return [ 
      p[0] * .01,
      p[1] * .01,
      p[2] * .01
    ]//return p;

  }



    </script>

  </body>
</html>
